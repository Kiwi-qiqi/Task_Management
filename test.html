<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务管理系统 - SQL.js实现</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        /* 保持原有的CSS样式不变 */
        /* 为了节省空间，这里省略了详细的CSS样式 */
        /* 实际使用时请保留完整的CSS样式代码 */
    </style>
</head>
<body>
    <div class="container">
        <!-- 页面标题 -->
        <div class="header text-center">
            <h1><i class="fas fa-tasks me-3"></i>任务管理系统</h1>
            <p class="lead">使用SQL.js在浏览器中直接操作SQLite数据库</p>
            <div class="db-status">
                <div class="db-status-indicator" id="dbStatus"></div>
                <span id="dbStatusText">数据库未加载</span>
            </div>
        </div>
        
        <div class="notification" id="notification"></div>
        
        <!-- 数据库操作区域 -->
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-database me-2"></i>数据库管理
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-section">
                            <h5 class="section-title"><i class="fas fa-cogs me-2"></i>数据库操作</h5>
                            <p>请加载您的SQLite数据库文件（taskmanager.db）以开始使用系统。所有操作都在本地执行。</p>
                            
                            <div class="db-actions">
                                <button class="btn btn-primary db-action-btn" id="loadDbBtn">
                                    <i class="fas fa-folder-open me-2"></i>加载数据库
                                </button>
                                <button class="btn btn-success db-action-btn" id="saveDbBtn">
                                    <i class="fas fa-save me-2"></i>保存数据库
                                </button>
                                <input type="file" id="dbFileInput" style="display: none;" accept=".db,.sqlite">
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-section">
                            <h5 class="section-title"><i class="fas fa-info-circle me-2"></i>数据库信息</h5>
                            <ul class="list-group">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    用户表记录
                                    <span class="badge bg-primary rounded-pill" id="userCount">0</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    类别表记录
                                    <span class="badge bg-success rounded-pill" id="categoryCount">0</span>
                                </
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    项目表记录
                                    <span class="badge bg-warning rounded-pill" id="projectCount">0</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    任务表记录
                                    <span class="badge bg-info rounded-pill" id="taskCount">0</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- 用户管理 -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-users me-2"></i>用户管理
                    </div>
                    <div class="card-body">
                        <div class="form-section">
                            <h5 class="section-title"><i class="fas fa-user-plus me-2"></i>添加新用户</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">用户ID *</label>
                                    <input type="text" class="form-control" id="userID" placeholder="输入唯一用户ID">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">用户名 *</label>
                                    <input type="text" class="form-control" id="username" placeholder="输入用户名">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">邮箱 *</label>
                                <input type="email" class="form-control" id="email" placeholder="输入邮箱">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">角色 *</label>
                                    <select class="form-select" id="role">
                                        <option value="admin">管理员</option>
                                        <option value="manager">经理</option>
                                        <option value="engineer">工程师</option>
                                        <option value="guest">访客</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">状态 *</label>
                                    <select class="form-select" id="userStatus">
                                        <option value="1">活跃</option>
                                        <option value="0">禁用</option>
                                    </select>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button class="btn btn-success" id="addUserBtn">
                                    <i class="fas fa-plus-circle me-2"></i>添加用户
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h5 class="section-title"><i class="fas fa-user-minus me-2"></i>删除用户</h5>
                            <div class="mb-3">
                                <label class="form-label">选择用户</label>
                                <select class="form-select" id="deleteUserSelect">
                                    <option value="">-- 选择要删除的用户 --</option>
                                </select>
                            </div>
                            <div class="d-grid">
                                <button class="btn btn-danger" id="deleteUserBtn">
                                    <i class="fas fa-trash-alt me-2"></i>删除用户
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 类别管理 -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-tags me-2"></i>类别管理
                    </div>
                    <div class="card-body">
                        <div class="form-section">
                            <h5 class="section-title"><i class="fas fa-folder-plus me-2"></i>添加新类别</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">类别名称 *</label>
                                    <input type="text" class="form-control" id="categoryName" placeholder="输入类别名称">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">类别类型 *</label>
                                    <select class="form-select" id="categoryType">
                                        <option value="project">项目</option>
                                        <option value="task">任务</option>
                                        <option value="department">部门</option>
                                        
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">描述</label>
                                <textarea class="form-control" id="categoryDescription" placeholder="类别描述"></textarea>
                            </div>
                            <div class="d-grid">
                                <button class="btn btn-success" id="addCategoryBtn">
                                    <i class="fas fa-plus-circle me-2"></i>添加类别
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h5 class="section-title"><i class="fas fa-edit me-2"></i>更新类别</h5>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">选择类别</label>
                                <select class="form-select" id="updateCategorySelect">
                                    <option value="">-- 选择要更新的类别 --</option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">新名称</label>
                                    <input type="text" class="form-control" id="newCategoryName" placeholder="输入新名称">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">状态</label>
                                    <select class="form-select" id="categoryStatus">
                                        <option value="active">活跃</option>
                                        <option value="inactive">不活跃</option>
                                        <option value="archived">已归档</option>
                                    </select>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button class="btn btn-warning" id="updateCategoryBtn">
                                    <i class="fas fa-sync-alt me-2"></i>更新类别
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h5 class="section-title"><i class="fas fa-trash-alt me-2"></i>删除类别</h5>
                            <div class="mb-3">
                                <label class="form-label">选择类别</label>
                                <select class="form-select" id="deleteCategorySelect">
                                    <option value="">-- 选择要删除的类别 --</option>
                                </select>
                            </div>
                            <div class="d-grid">
                                <button class="btn btn-danger" id="deleteCategoryBtn">
                                    <i class="fas fa-trash-alt me-2"></i>删除类别
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 项目管理 -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-project-diagram me-2"></i>项目管理
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-section">
                                    <h5 class="section-title"><i class="fas fa-plus-circle me-2"></i>添加新项目</h5>
                                    <div class="mb-3">
                                        <label class="form-label">项目名称 *</label>
                                        <input type="text" class="form-control" id="projectName" placeholder="输入项目名称">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">所属类别 *</label>
                                        <select class="form-select" id="projectCategory">
                                            <option value="">-- 选择类别 --</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">状态 *</label>
                                        <select class="form-select" id="projectStatus">
                                            <option value="planning">规划中</option>
                                            <option value="in_progress">进行中</option>
                                            <option value="completed">已完成</option>
                                        </select>
                                    </div>
                                    <div class="d-grid">
                                        <button class="btn btn-success" id="addProjectBtn">
                                            <i class="fas fa-plus-circle me-2"></i>添加项目
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-section">
                                    <h5 class="section-title"><i class="fas fa-edit me-2"></i>更新项目</h5>
                                    <div class="mb-3">
                                        <label class="form-label">选择项目</label>
                                        <select class="form-select" id="updateProjectSelect">
                                            <option value="">-- 选择要更新的项目 --</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">新名称</label>
                                        <input type="text" class="form-control" id="newProjectName" placeholder="输入新名称">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">状态</label>
                                        <select class="form-select" id="projectStatusUpdate">
                                            <option value="planning">规划中</option>
                                            <option value="in_progress">进行中</option>
                                            <option value="completed">已完成</option>
                                            <option value="delayed">已延期</option>
                                        </select>
                                    </div>
                                    <div class="d-grid">
                                        <button class="btn btn-warning" id="updateProjectBtn">
                                            <i class="fas fa-sync-alt me-2"></i>更新项目
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-section">
                                    <h5 class="section-title"><i class="fas fa-trash-alt me-2"></i>删除项目</h5>
                                    <div class="mb-3">
                                        <label class="form-label">选择项目</label>
                                        <select class="form-select" id="deleteProjectSelect">
                                            <option value="">-- 选择要删除的项目 --</option>
                                        </select>
                                    </div>
                                    <div class="d-grid">
                                        <button class="btn btn-danger" id="deleteProjectBtn">
                                            <i class="fas fa-trash-alt me-2"></i>删除项目
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 数据预览 -->
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <h4 class="mb-0"><i class="fas fa-table me-2"></i>数据预览 (<span id="currentTable">users</span>)</h4>
                <div class="d-flex">
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="showTable('users')">
                        <i class="fas fa-users me-1"></i>用户
                    </button>
                    <button class="btn btn-sm btn-outline-success me-2" onclick="showTable('categories')">
                        <i class="fas fa-tags me-1"></i>类别
                    </button>
                    <button class="btn btn-sm btn-outline-warning me-2" onclick="showTable('projects')">
                        <i class="fas fa-project-diagram me-1"></i>项目
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="showTable('tasks')">
                        <i class="fas fa-tasks me-1"></i>任务
                    </button>
                </div>
            </div>
            <table class="table table-hover" id="previewTable">
                <thead id="tableHeader">
                    <tr>
                        <th>ID</th>
                        <th>名称</th>
                        <th>状态</th>
                        <th>创建日期</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            <p class="mb-1">© 2023 任务管理系统 | 基于SQL.js实现</p>
            <p class="mb-0">所有数据存储在浏览器中，操作完成后请保存数据库</p>
        </div>
    </div>

    <script>
        // SQL.js数据库实例
        let db;
        
        // 显示通知
        function showNotification(message, isSuccess = true) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            
            if (isSuccess) {
                notification.classList.add('notification-success');
            } else {
                notification.classList.add('notification-error');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 更新数据库状态
        function updateDbStatus(connected) {
            const indicator = document.getElementById('dbStatus');
            const text = document.getElementById('dbStatusText');
            
            if (connected) {
                indicator.style.backgroundColor = '#2ecc71';
                text.textContent = '数据库已加载';
            } else {
                indicator.style.backgroundColor = '#e74c3c';
                text.textContent = '数据库未加载';
            }
        }
        
        // 加载数据库文件
        function loadDatabase(file) {
            const reader = new FileReader();
            reader.onload = function() {
                try {
                    const uInt8Array = new Uint8Array(reader.result);
                    db = new SQL.Database(uInt8Array);
                    
                    updateDbStatus(true);
                    showNotification('数据库加载成功');
                    
                    // 更新记录计数
                    updateRecordCounts();
                    
                    // 刷新下拉菜单
                    refreshDropdowns();
                    
                    // 显示用户表
                    showTable('users');
                } catch (err) {
                    showNotification('加载数据库失败: ' + err.message, false);
                    console.error('加载数据库出错:', err);
                }
            };
            reader.onerror = function() {
                showNotification('读取文件失败', false);
            };
            reader.readAsArrayBuffer(file);
        }
        
        // 更新记录计数
        function updateRecordCounts() {
            if (!db) return;
            
            try {
                // 用户表计数
                const userResult = db.exec("SELECT COUNT(*) as count FROM users");
                if (userResult.length > 0) {
                    const userCount = userResult[0].values[0][0];
                    document.getElementById('userCount').textContent = userCount;
                }
                
                // 类别表计数
                const categoryResult = db.exec("SELECT COUNT(*) as count FROM categories");
                if (categoryResult.length > 0) {
                    const categoryCount = categoryResult[0].values[0][0];
                    document.getElementById('categoryCount').textContent = categoryCount;
                }
                
                // 项目表计数
                const projectResult = db.exec("SELECT COUNT(*) as count FROM projects");
                if (projectResult.length > 0) {
                    const projectCount = projectResult[0].values[0][0];
                    document.getElementById('projectCount').textContent = projectCount;
                }
                
                // 任务表计数
                const taskResult = db.exec("SELECT COUNT(*) as count FROM tasks");
                if (taskResult.length > 0) {
                    const taskCount = taskResult[0].values[0][0];
                    document.getElementById('taskCount').textContent = taskCount;
                }
            } catch (err) {
                console.error('更新记录计数失败:', err);
            }
        }
        
        // 保存数据库到本地
        function saveDatabase() {
            if (!db) {
                showNotification('数据库未加载', false);
                return;
            }
            
            try {
                const data = db.export();
                const buffer = new Uint8Array(data);
                const blob = new Blob([buffer], {type: 'application/octet-stream'});
                
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'taskmanager_modified.db';
                a.click();
                
                showNotification('数据库已保存！');
            } catch (err) {
                showNotification('保存数据库失败: ' + err.message, false);
            }
        }
        
        // 刷新下拉菜单
        function refreshDropdowns() {
            refreshUserDropdown();
            refreshCategoryDropdown();
            refreshProjectDropdown();
        }
        
        // 刷新用户下拉菜单
        function refreshUserDropdown() {
            const select = document.getElementById('deleteUserSelect');
            select.innerHTML = '<option value="">-- 选择要删除的用户 --</option>';
            
            if (!db) return;
            
            try {
                const stmt = db.prepare('SELECT id, userID, username FROM users');
                while (stmt.step()) {
                    const user = stmt.getAsObject();
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.userID} - ${user.username}`;
                    select.appendChild(option);
                }
                stmt.free();
            } catch (err) {
                console.error('刷新用户下拉菜单失败:', err);
            }
        }
        
        // 刷新类别下拉菜单
        function refreshCategoryDropdown() {
            // 删除类别下拉菜单
            const deleteSelect = document.getElementById('deleteCategorySelect');
            deleteSelect.innerHTML = '<option value="">-- 选择要删除的类别 --</option>';
            
            // 更新类别下拉菜单
            const updateSelect = document.getElementById('updateCategorySelect');
            updateSelect.innerHTML = '<option value="">-- 选择要更新的类别 --</option>';
            
            // 项目类别下拉菜单
            const projectCategory = document.getElementById('projectCategory');
            projectCategory.innerHTML = '<option value="">-- 选择类别 --</option>';
            
            if (!db) return;
            
            try {
                const stmt = db.prepare('SELECT id, name FROM categories');
                while (stmt.step()) {
                    const category = stmt.getAsObject();
                    
                    // 填充删除下拉菜单
                    const deleteOption = document.createElement('option');
                    deleteOption.value = category.id;
                    deleteOption.textContent = category.name;
                    deleteSelect.appendChild(deleteOption);
                    
                    // 填充更新下拉菜单
                    const updateOption = document.createElement('option');
                    updateOption.value = category.id;
                    updateOption.textContent = category.name;
                    updateSelect.appendChild(updateOption);
                    
                    // 填充项目类别下拉菜单
                    const projectOption = document.createElement('option');
                    projectOption.value = category.id;
                    projectOption.textContent = category.name;
                    projectCategory.appendChild(projectOption);
                }
                stmt.free();
            } catch (err) {
                console.error('刷新类别下拉菜单失败:', err);
            }
        }
        
        // 刷新项目下拉菜单
        function refreshProjectDropdown() {
            const deleteSelect = document.getElementById('deleteProjectSelect');
            deleteSelect.innerHTML = '<option value="">-- 选择要删除的项目 --</option>';
            
            const updateSelect = document.getElementById('updateProjectSelect');
            updateSelect.innerHTML = '<option value="">-- 选择要更新的项目 --</option>';
            
            if (!db) return;
            
            try {
                const stmt = db.prepare('SELECT id, name FROM projects');
                while (stmt.step()) {
                    const project = stmt.getAsObject();
                    
                    // 填充删除下拉菜单
                    const deleteOption = document.createElement('option');
                    deleteOption.value = project.id;
                    deleteOption.textContent = project.name;
                    deleteSelect.appendChild(deleteOption);
                    
                    // 填充更新下拉菜单
                    const updateOption = document.createElement('option');
                    updateOption.value = project.id;
                    updateOption.textContent = project.name;
                    updateSelect.appendChild(updateOption);
                }
                stmt.free();
            } catch (err) {
                console.error('刷新项目下拉菜单失败:', err);
            }
        }
        
        // 显示表格数据
        function showTable(tableName) {
            if (!db) {
                showNotification('数据库未加载', false);
                return;
            }
            
            document.getElementById('currentTable').textContent = tableName;
            
            let sql = '';
            switch(tableName) {
                case 'users':
                    sql = 'SELECT id, userID, username, email, role, is_active, created_at FROM users';
                    break;
                case 'categories':
                    sql = 'SELECT id, name, type, status, created_at FROM categories';
                    break;
                case 'projects':
                    sql = 'SELECT id, name, status, created_at FROM projects';
                    break;
                case 'tasks':
                    sql = 'SELECT id, title, type, status, priority, created_at FROM tasks';
                    break;
                default:
                    sql = `SELECT * FROM ${tableName}`;
            }
            
            try {
                const stmt = db.prepare(sql);
                const columns = stmt.getColumnNames();
                
                // 构建表头
                const headerRow = document.createElement('tr');
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                
                // 添加操作列
                const actionTh = document.createElement('th');
                actionTh.textContent = '操作';
                headerRow.appendChild(actionTh);
                
                const tableHeader = document.getElementById('tableHeader');
                tableHeader.innerHTML = '';
                tableHeader.appendChild(headerRow);
                
                // 构建表体
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';
                
                while (stmt.step()) {
                    const rowData = stmt.get();
                    const row = document.createElement('tr');
                    
                    rowData.forEach((value, index) => {
                        const td = document.createElement('td');
                        
                        // 特殊格式化
                        if (columns[index] === 'is_active') {
                            td.innerHTML = value === 1 
                                ? '<span class="status-badge badge-active">活跃</span>' 
                                : '<span class="status-badge badge-inactive">禁用</span>';
                        } else if (columns[index] === 'status') {
                            let statusClass = 'badge-inactive';
                            let statusText = value;
                            
                            if (value === 'active' || value === 'in_progress' || value === 'todo') {
                                statusClass = 'badge-active';
                            }
                            
                            td.innerHTML = `<span class="status-badge ${statusClass}">${statusText}</span>`;
                        } else if (columns[index] === 'priority') {
                            let priorityClass = '';
                            let priorityText = value;
                            
                            if (value === 'high') {
                                priorityClass = 'badge-inactive';
                                priorityText = '高';
                            } else if (value === 'medium') {
                                priorityClass = 'badge-active';
                                priorityText = '中';
                            } else {
                                priorityText = '低';
                            }
                            
                            td.innerHTML = `<span class="status-badge ${priorityClass}">${priorityText}</span>`;
                        } else {
                            td.textContent = value;
                        }
                        
                        row.appendChild(td);
                    });
                    
                    // 添加操作按钮
                    const actionTd = document.createElement('td');
                    actionTd.innerHTML = `
                        <button class="btn btn-sm btn-primary action-btn" onclick="editRow('${tableName}', ${rowData[0]})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteRow('${tableName}', ${rowData[0]})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    row.appendChild(actionTd);
                    
                    tableBody.appendChild(row);
                }
                
                stmt.free();
            } catch (err) {
                console.error('显示表格数据失败:', err);
                showNotification('显示表格数据失败: ' + err.message, false);
            }
        }
        
        // 编辑行数据
        function editRow(tableName, id) {
            // 在实际应用中，这里会打开一个模态框进行编辑
            // 为简化实现，这里仅显示通知
            showNotification(`编辑${tableName}表中ID为${id}的记录`);
        }
        
        // 删除行数据
        function deleteRow(tableName, id) {
            if (confirm(`确定要删除${tableName}表中ID为${id}的记录吗？`)) {
                try {
                    db.run(`DELETE FROM ${tableName} WHERE id = ?`, [id]);
                    showNotification('记录已删除');
                    showTable(tableName); // 刷新表格
                    updateRecordCounts(); // 更新计数
                    
                    // 刷新相关的下拉菜单
                    if (tableName === 'users') {
                        refreshUserDropdown();
                    } else if (tableName === 'categories') {
                        refreshCategoryDropdown();
                    } else if (tableName === 'projects') {
                        refreshProjectDropdown();
                    }
                } catch (err) {
                    showNotification('删除记录失败: ' + err.message, false);
                }
            }
        }
        
        // 添加用户
        function addUser() {
            if (!db) {
                showNotification('数据库未加载', false);
                return;
            }
            
            const userId = document.getElementById('userID').value;
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const role = document.getElementById('role').value;
            const isActive = document.getElementById('userStatus').value;
            const fullName = username; // 简化处理
            
            if (!userId || !username || !email) {
                showNotification('用户ID、用户名和邮箱不能为空', false);
                return;
            }
            
            try {
                db.run(`INSERT INTO users (userID, username, email, role, is_active, full_name) 
                        VALUES (?, ?, ?, ?, ?, ?)`, 
                        [userId, username, email, role, parseInt(isActive), fullName]);
                
                showNotification(`用户 ${username} 添加成功！`);
                
                // 清空表单
                document.getElementById('userID').value = '';
                document.getElementById('username').value = '';
                document.getElementById('email').value = '';
                
                // 刷新UI
                refreshUserDropdown();
                showTable('users');
                updateRecordCounts();
            } catch (err) {
                showNotification('添加用户失败: ' + err.message, false);
            }
        }
        
        // 删除用户
        function deleteUser() {
            if (!db) {
                showNotification('数据库未加载', false);
                return;
            }
            
            const userId = document.getElementById('deleteUserSelect').value;
            
            if (!userId) {
                showNotification('请选择要删除的用户', false);
                return;
            }
            
            try {
                db.run('DELETE FROM users WHERE id = ?', [userId]);
                showNotification('用户已删除');
                
                // 刷新UI
                refreshUserDropdown();
                showTable('users');
                updateRecordCounts();
            } catch (err) {
                showNotification('删除用户失败: ' + err.message, false);
            }
        }
        
        // 添加类别
        function addCategory() {
            if (!db) {
                showNotification('数据库未加载', false);
                return;
            }
            
            const name = document.getElementById('categoryName').value;
            const type = document.getElementById('categoryType').value;
            const description = document.getElementById('categoryDescription').value;
            
            if (!name) {
                showNotification('类别名称不能为空', false);
                return;
            }
            
            try {
                db.run(`INSERT INTO categories (name, type, description) 
                        VALUES (?, ?, ?)`, 
                        [name, type, description]);
                
                showNotification(`类别 ${name} 添加成功！`);
                
                // 清空表单
                document.getElementById('categoryName').value = '';
                document.getElementById('categoryDescription').value = '';
                
                // 刷新UI
                refreshCategoryDropdown();
                showTable('categories');
                updateRecordCounts();
            } catch (err) {
                showNotification('添加类别失败: ' + err.message, false);
            }
        }
        
        // 更新类别
        function updateCategory() {
            if (!db) {
                showNotification('数据库未加载', false);
                return;
            }
            
            const categoryId = document.getElementById('updateCategorySelect').value;
            const newName = document.getElementById('newCategoryName').value;
            const status = document.getElementById('categoryStatus').value;
            
            if (!categoryId) {
                showNotification('请选择要更新的类别', false);
                return;
            }
            
            try {
                const updates = [];
                const values = [];
                
                if (newName) {
                    updates.push('name = ?');
                    values.push(newName);
                }
                
                if (status) {
                    updates.push('status = ?');
                    values.push(status);
                }
                
                if (updates.length === 0) {
                    showNotification('没有可更新的内容', false);
                    return;
                }
                
                const updateQuery = `UPDATE categories SET ${updates.join(', ')} WHERE id = ?`;
                values.push(categoryId);
                
                db.run(updateQuery, values);
                
                showNotification('类别信息已更新');
                
                // 清空表单
                document.getElementById('updateCategorySelect').value = '';
                document.getElementById('newCategoryName').value = '';
                
                // 刷新UI
                refreshCategoryDropdown();
                showTable('categories');
                updateRecordCounts();
            } catch (err) {
                showNotification('更新类别失败: ' + err.message, false);
            }
        }
        
        // 删除类别
        function deleteCategory() {
            if (!db) {
                showNotification('数据库未加载', false);
                return;
            }
            
            const categoryId = document.getElementById('deleteCategorySelect').value;
            
            if (!categoryId) {
                showNotification('请选择要删除的类别', false);
                return;
            }
            
            try {
                db.run('DELETE FROM categories WHERE id = ?', [categoryId]);
                showNotification('类别已删除');
                
                // 刷新UI
                refreshCategoryDropdown();
                showTable('categories');
                updateRecordCounts();
            } catch (err) {
                showNotification('删除类别失败: ' + err.message, false);
            }
        }
        
        // 添加项目
        function addProject() {
            if (!db) {
                showNotification('数据库未加载', false);
                return;
            }
            
            const name = document.getElementById('projectName').value;
            const categoryId = document.getElementById('projectCategory').value;
            const status = document.getElementById('projectStatus').value;
            
            if (!name || !categoryId) {
                showNotification('项目名称和类别不能为空', false);
                return;
            }
            
            try {
                db.run(`INSERT INTO projects (name, status, category_id) 
                        VALUES (?, ?, ?)`, 
                        [name, status, categoryId]);
                
                showNotification(`项目 ${name} 添加成功！`);
                
                // 清空表单
                document.getElementById('projectName').value = '';
                
                // 刷新UI
                refreshProjectDropdown();
                showTable('projects');
                updateRecordCounts();
            } catch (err) {
                showNotification('添加项目失败: ' + err.message, false);
            }
        }
        
        // 更新项目
        function updateProject() {
            if (!db) {
                showNotification('数据库未加载', false);
                return;
            }
            
            const projectId = document.getElementById('updateProjectSelect').value;
            const newName = document.getElementById('newProjectName').value;
            const status = document.getElementById('projectStatusUpdate').value;
            
            if (!projectId) {
                showNotification('请选择要更新的项目', false);
                return;
            }
            
            try {
                const updates = [];
                const values = [];
                
                if (newName) {
                    updates.push('name = ?');
                    values.push(newName);
                }
                
                if (status) {
                    updates.push('status = ?');
                    values.push(status);
                }
                
                if (updates.length === 0) {
                    showNotification('没有可更新的内容', false);
                    return;
                }
                
                const updateQuery = `UPDATE projects SET ${updates.join(', ')} WHERE id = ?`;
                values.push(projectId);
                
                db.run(updateQuery, values);
                
                showNotification('项目信息已更新');
                
                // 清空表单
                document.getElementById('updateProjectSelect').value = '';
                document.getElementById('newProjectName').value = '';
                
                // 刷新UI
                refreshProjectDropdown();
                showTable('projects');
                updateRecordCounts();
            } catch (err) {
                showNotification('更新项目失败: ' + err.message, false);
            }
        }
        
        // 删除项目
        function deleteProject() {
            if (!db) {
                showNotification('数据库未加载', false);
                return;
            }
            
            const projectId = document.getElementById('deleteProjectSelect').value;
            
            if (!projectId) {
                showNotification('请选择要删除的项目', false);
                return;
            }
            
            try {
                db.run('DELETE FROM projects WHERE id = ?', [projectId]);
                showNotification('项目已删除');
                
                // 刷新UI
                refreshProjectDropdown();
                showTable('projects');
                updateRecordCounts();
            } catch (err) {
                showNotification('删除项目失败: ' + err.message, false);
            }
        }
        
        // 初始化SQL.js (修复了函数名冲突)
        async function initializeSQL() {
            try {
                // 使用全局的initSqlJs函数
                const SQL = await window.initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                
                // 先创建一个空数据库
                db = new SQL.Database();
                updateDbStatus(false);
                
                showNotification('SQL.js初始化成功');
                return SQL;
            } catch (err) {
                console.error('SQL.js初始化失败:', err);
                showNotification('SQL.js初始化失败: ' + err.message, false);
            }
        }
        
        // 初始化事件监听器
        function initEventListeners() {
            // 数据库操作
            document.getElementById('loadDbBtn').addEventListener('click', () => {
                document.getElementById('dbFileInput').click();
            });
            
            document.getElementById('dbFileInput').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    loadDatabase(e.target.files[0]);
                }
            });
            
            document.getElementById('saveDbBtn').addEventListener('click', saveDatabase);
            
            // 用户管理
            document.getElementById('addUserBtn').addEventListener('click', addUser);
            document.getElementById('deleteUserBtn').addEventListener('click', deleteUser);
            
            // 类别管理
            document.getElementById('addCategoryBtn').addEventListener('click', addCategory);
            document.getElementById('updateCategoryBtn').addEventListener('click', updateCategory);
            document.getElementById('deleteCategoryBtn').addEventListener('click', deleteCategory);
            
            // 项目管理
            document.getElementById('addProjectBtn').addEventListener('click', addProject);
            document.getElementById('updateProjectBtn').addEventListener('click', updateProject);
            document.getElementById('deleteProjectBtn').addEventListener('click', deleteProject);
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', async () => {
            await initializeSQL();
            initEventListeners();
        });
    </script>
</body>
</html>